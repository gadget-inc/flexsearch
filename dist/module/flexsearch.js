"use strict";import"./serialize.js";import"./where.js";import Cache from"./cache.js";import Worker from"./worker.js";import presets from"./presets.js";import{encode as default_encoder}from"./lang/latin/default.js";import{addWorker}from"./worker.js";import{is_undefined,is_string,is_array,is_function,is_object,get_keys,create_object,create_object_array,regex}from"./common.js";let id_counter=0;export const global_lang={};export const global_charset={};export default function FlexSearch(a){if(!(this instanceof FlexSearch))return new FlexSearch(a);const b=a&&a.id;this.id=b||0===b?b:id_counter++,this.init(a),register_property(this,"index",function(){return this.doc?get_keys(this.doc.index[this.doc.keys[0]]._ids):get_keys(this._ids)}),register_property(this,"length",function(){return this.index.length})}FlexSearch.registerCharset=function(a,b){return global_charset[a]=b,FlexSearch},FlexSearch.registerLanguage=function(a,b){return global_lang[a]=b,FlexSearch},FlexSearch.prototype.init=function(a){let b,c;if(a&&(is_string(a)?(!1,a=presets[a]):(b=a.preset)&&(!1,a=Object.assign({},presets[b],a))),a||(a={}),b=a.worker){if("undefined"==typeof Worker)a.worker=!1,this._worker=null;else{const c=parseInt(b,10)||4;this._current_task=-1,this._task_completed=0,this._task_result=[],this._current_callback=null,this._worker=Array(c);for(let b=0;b<c;b++)this._worker[b]=addWorker(this.id,b,a,this.worker_handler)}this.worker=b}this.async=a.async,this.timer=0;let d=a.charset,e=a.lang;if(is_string(d)&&(-1===d.indexOf(":")&&(d+=":default"),d=global_charset[d]),is_string(e)&&(e=global_lang[e]),this.tokenizer=b=d&&d.tokenize||a.tokenize||"strict",this.depth="strict"===b&&a.depth||0,this.rtl=d&&d.rtl||a.rtl||!1,this.resolution=a.resolution||9,this.threshold=b=a.threshold||0,this.resolution<=b&&(this.resolution=b+1),this.encode=a.encode||d&&d.encode||default_encoder,this.matcher=(b=a.matcher||e&&e.matcher)&&init_stemmer_or_matcher(b,!1),this.stemmer=(b=a.stemmer||e&&e.stemmer)&&init_stemmer_or_matcher(b,!0),this.filter=(b=a.filter||e&&e.filter)&&init_filter(b),this.doc=c=(b=a.doc)&&clone_object(b),c&&(a.doc=null),this._map=create_object_array(this.resolution-this.threshold),this._ctx=create_object(),this._ids=create_object(),c){this._doc=create_object();const b=c.index={},d=c.keys=[];let e=c.field,f=c.tag,g=c.store;if(is_array(c.id)||(c.id=c.id.split(":")),g){let a=create_object();if(is_string(g))a[g]=1;else if(is_array(g))for(let b=0;b<g.length;b++)a[g[b]]=1;else is_object(g)&&(a=g);c.store=a}if(f){this._tag=create_object();let b=create_object();if(e)if(is_string(e))b[e]=a;else if(is_array(e))for(let c=0;c<e.length;c++)b[e[c]]=a;else is_object(e)&&(b=e);is_array(f)||(c.tag=f=[f]);for(let a=0;a<f.length;a++)this._tag[f[a]]=create_object();this._tags=f,e=b}if(e){let f;is_array(e)||(is_object(e)?(f=e,c.field=e=get_keys(e)):c.field=e=[e]);for(let c=0;c<e.length;c++){const g=e[c];is_array(g)||(f&&(a=f[g]),d[c]=g,e[c]=g.split(":")),b[g]=new FlexSearch(a)}}}return this._cache_status=!0,this._cache=(b=a.cache)&&new Cache(b),this};function clone_object(a){const b=create_object();for(const c in a)if(a.hasOwnProperty(c)){const d=a[c];b[c]=is_array(d)?d.slice(0):is_object(d)?clone_object(d):d}return b}FlexSearch.prototype.add=function(b,a,c,d,e){if(this.doc&&is_object(b))return this.handle_docs("add",b,a);if(a&&is_string(a)&&(b||0===b)){if(this._ids[b]&&!d)return this.update(b,a);if(!e){if(this.async&&"function"!=typeof importScripts){let e=this;const f=new Promise(function(c){setTimeout(function(){e.add(b,a,null,d,!0),e=null,c()})});if(c)f.then(c);else return f;return this}if(c)return this.add(b,a,null,d,!0),c(),this}if(a=this.encode(a),!a.length)return this;const f=a,g=create_object();g._ctx=create_object();const h=f.length,j=this.threshold,k=this.depth,l=this.resolution,m=this._map,n=this.rtl;let o;for(let a=0;a<h;a++){const c=f[a];if(c){o=1;const d=c.length,e=(n?a+1:h-a)/h;let i="";switch(this.tokenizer){case"reverse":case"both":for(let f=d;--f;)i=c[f]+i,add_index(m,g,i,b,n?1:(d-f)/d,e,j,l-1);i="";case"forward":for(let f=0;f<d;f++)i+=c[f],add_index(m,g,i,b,n?(f+1)/d:1,e,j,l-1);break;case"full":for(let a=0;a<d;a++){const f=(n?a+1:d-a)/d;for(let h=d;h>a;h--)i=c.substring(a,h),add_index(m,g,i,b,f,e,j,l-1)}break;default:const o=add_index(m,g,c,b,1,e,j,l-1);if(k&&1<h&&o>=j){const d=g._ctx[c]||(g._ctx[c]=create_object()),e=this._ctx[c]||(this._ctx[c]=create_object_array(l-(j||0)));let i=a-k,m=a+k+1;for(0>i&&(i=0),m>h&&(m=h);i<m;i++)i!==a&&add_index(e,d,f[i],b,0,l-(i<a?a-i:i-a),j,l-1)}}}}o&&(this._ids[b]=1),this._cache_status=!1}return this},FlexSearch.prototype.handle_docs=function(a,b,c){if(is_array(b)){let d=b.length;if(d)for(let e=0;e<d;e++)this.handle_docs(a,b[e],e===d-1&&c)}else{const d=this.doc.index,e=this.doc.keys,f=this.doc.tag,g=this.doc.store;let h,i;h=this.doc.id;let j=b;for(let a=0;a<h.length;a++)j=j[h[a]];if("remove"===a){delete this._doc[j];let a=e.length;if(a)for(let b=0;b<a;b++)d[e[b]].remove(j,b===a-1&&c)}else{if(f){let a,c;for(let d=0;d<f.length;d++){a=f[d],c=b;const e=a.split(":");for(let b=0;b<e.length;b++)c=c[e[b]];c="@"+c}i=this._tag[a],i=i[c]||(i[c]=[])}h=this.doc.field;for(let f=0,g=h.length;f<g;f++){const i=h[f];let k=b;for(let a=0;a<i.length;a++)k=k[i[a]];const l=d[e[f]];"add"===a?l.add(j,k,f===g-1&&c):l.update(j,k,f===g-1&&c)}if(g){const a=get_keys(g);let c=create_object();for(let d,e=0;e<a.length;e++)if(d=a[e],g[d]){const e=d.split(":");let f,g;for(let d=0;d<e.length;d++){const a=e[d];f=(f||b)[a],g=(g||c)[a]=f}}b=c}i&&(i[i.length]=b),this._doc[j]=b}}return this},FlexSearch.prototype.update=function(a,b,c){return this.doc&&is_object(a)?this.handle_docs("update",a,b):(this._ids[a]&&is_string(b)&&(this.remove(a),this.add(a,b,c,!0)),this)},FlexSearch.prototype.remove=function(a,b,c){if(this.doc&&is_object(a))return this.handle_docs("remove",a,b);const d=a;if(this._ids[d]){if(!c){if(this.async&&"function"!=typeof importScripts){let c=this;const d=new Promise(function(b){setTimeout(function(){c.remove(a,null,!0),c=null,b()})});if(b)d.then(b);else return d;return this}if(b)return this.remove(a,null,!0),b(),this}for(let b=0;b<this.resolution-(this.threshold||0);b++)remove_index(this._map[b],a);this.depth&&remove_index(this._ctx,a),delete this._ids[d],this._cache_status=!1}return this};let field_to_sort;function enrich_documents(a,b){const c=a.length,d=Array(c);for(let e=0;e<c;e++)d[e]=b[a[e]];return d}FlexSearch.prototype.merge_and_sort=function(a,b,c,d,e,f,g,h,i,j){c=intersect(c,g?0:e,h,f,b,i,j);let k;return h&&(h=c.page,k=c.next,c=c.result),c=g?this.where(g,null,e,c):enrich_documents(c,this._doc),d&&(!is_function(d)&&(field_to_sort=d.split(":"),d=1<field_to_sort.length?sort_by_deep_field_up:sort_by_field_up),c.sort(d)),c=create_page(h,k,c),this._cache&&this._cache.set(a,c),c},FlexSearch.prototype.search=function(b,c,d,e){if(is_object(c)){if(is_array(c))for(let a=0;a<c.length;a++)c[a].query=b;else c.query=b;b=c,c=1000}else c&&is_function(c)?(d=c,c=1000):c||0===c||(c=1000);let f,g,h,i,j=[],k=b;if(!is_object(b)||is_array(b)||(!d&&(d=b.callback,d&&(k.callback=null)),h=b.sort,g=b.page,c=b.limit,f=b.threshold,i=b.suggest,b=b.query),this.doc){const a=this.doc.index,e=k.where,f=k.bool||"or";let l,m,n,o=k.field,p=f;if(o)is_array(o)||(o=[o]);else if(is_array(k)){l=k,o=[],p=[];for(let a=0;a<k.length;a++){const b=k[a],c=b.bool||f;o[a]=b.field,p[a]=c,"not"===c?m=!0:"and"===c&&(n=!0)}}else o=this.doc.keys;const q=o.length;for(let b=0;b<q;b++)l&&(k=l[b]),g&&!is_string(k)&&(k.page=null,k.limit=0),j[b]=a[o[b]].search(k,0);if(d)return d(this.merge_and_sort(b,p,j,h,c,i,e,g,n,m));if(this.async){const a=this;return new Promise(function(d){Promise.all(j).then(function(f){d(a.merge_and_sort(b,p,f,h,c,i,e,g,n,m))})})}return this.merge_and_sort(b,p,j,h,c,i,e,g,n,m)}if(f||(f=this.threshold||0),!e){if(this.async&&"function"!=typeof importScripts){let a=this;const b=new Promise(function(b){setTimeout(function(){b(a.search(k,c,null,!0)),a=null})});if(d)b.then(d);else return b;return this}if(d)return d(this.search(k,c,null,!0)),this}if(!b||!is_string(b))return j;if(k=b,this._cache)if(this._cache_status){const a=this._cache.get(b);if(a)return a}else this._cache.clear(),this._cache_status=!0;if(k=this.encode(k),!k.length)return j;const l=k,m=l.length;let n=!0;const o=[],p=create_object();let q,r,s=0;1<m&&(this.depth?r=!0:l.sort(sort_by_length_down));let t;if(!r||(t=this._ctx))for(const a=this.resolution;s<m;s++){let b=l[s];if(b){if(r){if(!q)if(t[b])q=b,p[b]=1;else if(!i)return j;if(i&&s==m-1&&!o.length)r=!1,b=q||b,p[b]=0;else if(!q)continue}if(!p[b]){const c=[];let d=!1,e=0;const g=r?t[q]:this._map;if(g){let h;for(let i=0;i<a-f;i++)(h=g[i]&&g[i][b])&&(c[e++]=h,d=!0)}if(d)q=b,o[o.length]=1<e?c.concat.apply([],c):c[0];else if(!i){n=!1;break}p[b]=1}}}else n=!1;return n&&(j=intersect(o,c,g,i)),this._cache&&this._cache.set(b,j),j},FlexSearch.prototype.info=function(){return{id:this.id,items:this.length,matcher:this.matcher.length,worker:this.worker,threshold:this.threshold,depth:this.depth,resolution:this.resolution,contextual:this.depth&&"strict"===this.tokenizer}},FlexSearch.prototype.clear=function(){return this.destroy().init()},FlexSearch.prototype.destroy=function(){if(this._cache&&(this._cache.clear(),this._cache=null),this._map=this._ctx=this._ids=null,this.doc){const a=this.doc.keys;for(let b=0;b<a.length;b++)this.doc.index[a[b]].destroy();this.doc=this._doc=null}return this};function register_property(a,b,c){Object.defineProperty(a,b,{get:c})}function add_index(a,b,c,d,e,f,g,h){if(b[c])return b[c];const i=e?(h-(g||h/1.5))*f+(g||h/1.5)*e:f;if(b[c]=i,i>=g){let b=a[h-(i+0.5>>0)];b=b[c]||(b[c]=[]),b[b.length]=d}return i}function remove_index(b,c){if(b){const a=get_keys(b);for(let d=0,e=a.length;d<e;d++){const e=a[d],f=b[e];if(f)for(let d=0,a=f.length;d<a;d++)if(f[d]===c){1===a?delete b[e]:f.splice(d,1);break}else is_object(f[d])&&remove_index(f[d],c)}}}function init_filter(a){const b=create_object();for(let c=0,d=a.length;c<d;c++)b[a[c]]=1;return b}function init_stemmer_or_matcher(a,b){const c=get_keys(a),d=c.length,e=[];let f="",g=0;for(let h,j=0;j<d;j++){const d=c[j];(h=a[d])?(e[g++]=regex(b?"(?!\\b)"+d+"(\\b|_)":d),e[g++]=h):f+=(f?"|":"")+d}return f&&(e[g++]=regex(b?"(?!\\b)("+f+")(\\b|_)":"("+f+")"),e[g]=""),e}function sort_by_length_down(c,a){return a.length-c.length}function sort_by_field_up(c,d){return c=c[field_to_sort],d=d[field_to_sort],c<d?-1:c>d?1:0}function sort_by_deep_field_up(c,d){const e=field_to_sort.length;for(let a=0;a<e;a++)c=c[field_to_sort[a]],d=d[field_to_sort[a]];return c<d?-1:c>d?1:0}function create_page(a,b,c){return a?{page:a,next:b?""+b:null,result:c}:c}function intersect(a,b,c,d,e,f,g){let h,j,k=[];!0===c?(c="0",j=""):j=c&&c.split(":");const l=a.length;if(1<l){const m=create_object(),n=[];let o,p,q,r,s,t,u,v,w,x=0,y=0,i=!0,z=0;if(j&&(2===j.length?(v=j,j=!1):j=w=parseInt(j[0],10)),g){for(o=create_object();x<l;x++)if("not"===e[x])for(p=a[x],q=p.length,y=0;y<q;y++)o["@"+p[y]]=1;else u=x+1;if(is_undefined(u))return create_page(c,h,k);x=0}else t=is_string(e)&&e;for(let v,A;x<l;x++){const B=x===(u||l)-1;if(!t||!x){const a=t||e&&e[x];if(!a||"and"===a)v=f=!0,A=!1;else if("or"===a)A=!0,v=!1;else continue}if(p=a[x],q=p.length,!q){if(v&&!d)return create_page(c,h,p);continue}if(i)if(s){const a=s.length;for(y=0;y<a;y++){const a=s[y],b="@"+a;g&&o[b]||(m[b]=1,!f&&(k[z++]=a))}s=null,i=!1}else{s=p;continue}let C=!1;for(y=0;y<q;y++){r=p[y];const a="@"+r,e=f?m[a]||0:x;if(e||d){if(g&&o[a])continue;if(!f&&m[a])continue;if(e===x){if(!B)m[a]=x+1;else if((!w||--w<z)&&(k[z++]=r,b&&z===b))return create_page(c,z+(j||0),k);C=!0}else if(d){const a=n[e]||(n[e]=[]);a[a.length]=r}}}if(v&&!C&&!d)break}if(s){const a=s.length;if(g)for(y=j?parseInt(j,10):0;y<a;y++){const a=s[y];o["@"+a]||(k[z++]=a)}else k=s}if(d)for(z=k.length,v?(x=parseInt(v[0],10)+1,y=parseInt(v[1],10)+1):(x=n.length,y=0);x--;)if(r=n[x],r){for(q=r.length;y<q;y++){const a=r[y];if((!g||!o["@"+a])&&(k[z++]=a,b&&z===b))return create_page(c,x+":"+y,k)}y=0}}else l&&(e&&"not"===e[0]||(k=a[0],j&&(j=parseInt(j[0],10))));if(b){const a=k.length;j&&j>a&&(j=0);const c=j||0;h=c+b,h<a?k=k.slice(c,h):(h=0,c&&(k=k.slice(c)))}return create_page(c,h,k)}